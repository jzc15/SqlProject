# 数据库项目文档

2015011343 陈宇
2015011337 季智成

---

## 系统结构设计

![image_1c3e2iiv01tsr75h1vhc139q1k6o9.png-56kB][1]

## 系统功能

基本功能：数据的增删查改，创建和删除数据库和数据表。
索引：B+树索引，唯一键值hash，复键值hash。
查询优化：只支持AND，对于单表查询使用已有索引进行估价，对于多表查询使用拓扑排序确定一个最佳的查询顺序，对于外键和主键有优化。
外键约束：插入时检查外键是否存在，删除时一并删除相关联的数据
支持多种类型：
```
1.	#define INT_TYPE ("int")  
2.	#define CHAR_TYPE ("char")  
3.	#define VARCHAR_TYPE ("varchar")  
4.	#define DATE_TYPE ("date") // DATE储存为time_t
5.	#define FLOAT_TYPE ("float")  
6.	#define DECIMAL_TYPE ("decimal") // 定点数，两个int，9位 
```
支持三个或以上表的连接：已完成，对于有外键约束的查询有优化
聚集查询：支持AVG,SUM,MIN,MAX,COUNT
模糊查询：已实现，转化为正则表达式判断
散列索引：对主键建有hash索引


## 主要模块设计原理

### *页式文件系统

### 记录管理模块

#### 表结构定义

为了使用一种通用的描述来描述所有情况，表结构的相关信息使用json字符串描述，这样在底层可以根据一个json字符串相关数据来生成一份记录。根据ppt上变长数据的存放规则封装。

![image_1c3femki1je5ie91hh8qr56d9.png-86.9kB][2]

#### 记录存储方式

首先由一个首页来记录当前每页的容量，每一页中首先是页数据，然后每一项记录信息（起始位置，长度）位于页头，记录均从尾部开始倒序存放，示意图如下：

![image_1c3feu3ss1qar16u99khopa8l82m.png-32.9kB][3]


### 索引模块

#### B+树索引

对主键生成B+树索引，B+树的叶子节点存放数据，非叶节点用了存放分界值。每访问到某个节点时，从内存中取出并读取，修改后存到内存中。

考虑到查询优化，我们在B+树的每个节点中维护了以此节点为根的子树的大小，这样每次查询的同时可以快速知道查询结果有多少条。有多个查询约束时，可以先拿出数量最小的那一个约束，然后再这些数据中检查其他约束。

#### *哈希索引

哈希索引主要用来优化相等条件查询。散列使用平方探测法，提高查找速度。

### 系统管理模块

我们使用文件夹来存储一个数据库。对于每个数据表，在数据库文件夹下建立文件来存储数据表，使用页式文件系统管理次数据表文件，并额外创建表描述文件。添加删除数据库的操作对应文件夹的新建与删除，添加删除数据表的操作对应文件的新建与删除。

### 查询解析模块

#### 基础功能：增删改查


#### *多表查询

使用枚举法逐一比较

#### *聚集查询

解析语法新增关键词AVG,SUM,MIN,MAX
在获取查询结果后根据语句计算结果

#### *模糊查询

解析语法新增%等通配符
使用枚举法逐一比较

#### *查询优化

对于单属性查询，等于查询使用散列索引，关于主键的约束使用B+树索引解决。
有多个查询约束时，可以先拿出数量最小的那一个约束，然后再这些数据中检查其他约束。


### UI模块

UI模块使用django实现了一个简易的网页。网页中提供一个搜索框用于输入sql语句，UI模块会将此sql语句，加上所处的数据库位置等信息封装成一系列sql语句，交给底层模块获取结果，然后通过网页展示出来。

## 实验结果



## 小组分工

+ 季智成：
存储模块中与文件系统的交互
封装manager类，实现了二进制记录与文件的相关操作，包括插入删除查找。
索引模块中b+树的维护
实现包括文件与记录的相关操作
GUI

+ 陈宇：
页式文件系统
数据库结构描述
记录的序列化与反序列化，支持多种数据类型
前端使用yac+lexer对命令解析
核心引擎，和各个模块交互
基础数据结构(typedef shared_ptr<vector<uint8>> data_t)相关基础操作，包括初始化、比较等
对查询进行估价、使用拓扑排序确定最佳查询顺序，多表链接
外键约束、查询和修改等类型判断
聚类查询和模糊查询
唯一键值hash，复键值hash

## 参考文献

《算法设计》
《算法导论》

## 项目源码

### github仓库地址

https://github.com/jzc15/SqlProject

### 目录说明

* `datamanager` : 数据管理模块，定义了槽文件系统和向量文件系统

* `ddf` : 数据库/数据表描诉文件，实现了数据库/表/记录的描述类，实现了记录序列化/反序列化等接口

* `disk` : 页式文件系统，以及其他和磁盘交互的接口

* `frontend` : 前段模块，负责解析命令

* `json11` : 外部引用json模块

* `engine` : 核心引擎，负责组合各个模块，完成增删查改等各个指令

* `indices` : 索引模块，实现了B+树索引，唯一键值散列索引，可重键值散列索引

* `src` : 入口程序，每个文件代表一个可执行文件，包含main以及各个模块的单元测试

* `ui` : 网页GUI

### 环境安装

+ 解析部分，使用lex&yacc

```
sudo apt-get install flex bison
```

+ GUI部分，使用python3，django2.0
```
sudo apt-get python3
sudo apt-get python3-pip
pip3 install django
```

### GUI运行说明

```sh
> cd ui
> python3 manager.py runserver 0.0.0.0:<port>
```


  [1]: http://static.zybuluo.com/jzc/rg46zcshk65xzdfwmbsy8pzo/image_1c3e2iiv01tsr75h1vhc139q1k6o9.png
  [2]: http://static.zybuluo.com/jzc/ppjj5nz7qbjjnspz4dbyoicl/image_1c3femki1je5ie91hh8qr56d9.png
  [3]: http://static.zybuluo.com/jzc/fkgedk5auc5ofdyarlidj3rg/image_1c3feu3ss1qar16u99khopa8l82m.png